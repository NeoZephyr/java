FastDFS是一个开源的轻量级分布式文件系统。它解决了大数据量存储和负载均衡等问题。特别适合以中小文件（建议范围：4KB < file_size < 500MB）为载体的在线服务

FastDFS服务端有三个角色：跟踪服务器（tracker server）、存储服务器（storage server）和客户端（client）

跟踪服务器：主要做调度工作，起负载均衡的作用。在内存中记录集群中所有存储组和存储服务器的状态信息

每个storage在启动后会连接Tracker，告知自己所属的group等信息，并保持周期性的心跳，tracker根据storage的心跳信息，建立group==>[storage server list]的映射表

存储服务器：文件和文件属性（meta data）都保存到存储服务器上。Storage server直接利用OS的文件系统调用管理文件

storage 以组为单位组织，一个group内包含多台storage机器，数据互为备份

group内每个storage的存储依赖于本地文件系统，storage可配置多个数据存储目录，比如有10块磁盘，分别挂载在 /data/disk1-/data/disk10，则可将这10个目录都配置为storage的数据存储目录

storage接受到写文件请求时，会根据配置好的规则，选择其中一个存储目录来存储文件。为了避免单个目录下的文件数太多，在storage第一次启动时，会在每个数据存储目录里创建2级子目录，每级256个，总共65536个文件，新写的文件会以hash的方式被路由到其中某个子目录下，然后将文件数据直接作为一个本地文件存储到该目录中

组：同组内服务器上的文件是完全相同的 ，同一组内的storage server之间是对等的， 文件上传、 删除等操作可以在任意一台storage server上进行

上传机制
1. 选择tracker server，当tracker接收到upload file的请求时，会为该文件分配一个可以存储该文件的group，支持如下选择group的规则：
Round robin，轮询所有的group
Specified group，指定某一个确定的group
Load balance，剩余空间多的 group 优先
2. 选择storage server，tracker会在group内选择一个storage server给客户端，支持如下选择storage的规则：
Round robin，轮询 group内的所有storage
First server ordered by ip，按 ip 排序
First server ordered by priority，按优先级排序（优先级在storage上配置）
3. 选择storage path
storage 为文件分配一个数据存储目录，支持如下规则：
Round robin，多个存储目录间轮询
剩余存储空间最多的优先
4. 生成 Fileid
由storage server ip、文件创建时间、文件大小、文件crc32和一个随机数拼接而成，然后将这个二进制串进行base64编码，转换为可打印的字符串
5. 生成文件名
文件名由group、存储目录、两级子目录、fileid、文件后缀名拼接而成

下载机制
客户端带上文件名信息请求Tracker服务获取到存储服务器的ip地址和端口，然后客户端根据返回的IP地址和端口号请求下载文件，存储服务器接收到请求后返回文件给客户端

文件索引：客户端上传文件后存储服务器返回给客户端，用于以后访问该文件的索引信息。文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名。



